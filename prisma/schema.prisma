// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===================================
// MODEL INTI
// ===================================

model Machine {
  id              String                @id
  type            String                @default("unknown")
  // Latest sensor readings (denormalized fields)
  airTemperature      Float?
  processTemperature  Float?
  rotationalSpeed     Int?
  torque              Float?
  toolWear            Int?
  sensorTimestamp     DateTime?

  classification      String?           // Classification from ML payload

  predictions     Prediction[]
  tickets         MaintenanceTicket[]

  @@map("machines")
}

// Prediksi dari ML
model Prediction {
  id                   Int       @id @default(autoincrement())
  machineId            String

  // Prediction results
  prediction           String    // Predicted Failure Type (Current)
  forecast             String?   // Forecast Failure Type (Future)
  recommendation       String?   @db.Text
  // Forecast timestamp (parsed)
  forecastFailureTimestamp DateTime?

  // Forecast info
  predictedAt          DateTime  @default(now())

  // Raw data untuk audit/debug
  rawPayload           Json?

  // Metadata
  createdAt            DateTime  @default(now())

  // Relasi: Menghubungkan ke tabel Machine
  machine              Machine   @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@map("predictions")
  @@index([machineId])
  @@index([predictedAt])
}

// Tiket Maintenance (DIUPDATE)
model MaintenanceTicket {
  id        Int       @id @default(autoincrement())
  machineId String
  title     String    @default("Untitled")

  issue             String    @db.Text
  status            Boolean   @default(true)      // true=opened, false=closed
  priority          String?   @default("MEDIUM") // LOW|MEDIUM|HIGH|URGENT
  expectedFailureAt DateTime?
  createdAt         DateTime  @default(now())
  closedAt          DateTime?

  // Relasi: Menghubungkan ke tabel Machine
  machine   Machine   @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@map("maintenance_tickets")
  @@index([machineId])
  @@index([status])
  @@index([createdAt])
}

// ===================================
// CHATBOT MODELS 
// ===================================

// 1. Sesi Chat (Judul di Sidebar)
model ChatSession {
  id        String        @id @default(cuid())
  title     String?       // Field baru sesuai referensi (opsional untuk judul chat)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  messages  ChatMessage[]

  @@map("chat_sessions")
}

// 2. Isi Chat (Gelembung Pesan)
model ChatMessage {
  id        Int      @id @default(autoincrement())
  content   String   @db.Text
  role      String   // "user" | "assistant"
  createdAt DateTime @default(now())

  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
  @@index([sessionId, createdAt])
}
