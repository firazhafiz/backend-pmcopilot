// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===================================
// MODEL INTI (TIDAK DIUBAH)
// ===================================

model Machine {
  id   String @id
  type String @default("unknown")

  sensorReadings SensorData[]
  predictions    Prediction[]
  tickets        MaintenanceTicket[]

  @@map("machines")
}

// Raw sensor data sesuai input model ML
model SensorData {
  id                 Int      @id @default(autoincrement())
  airTemperature     Float
  processTemperature Float
  rotationalSpeed    Int
  torque             Float
  toolWear           Int
  timestamp          DateTime @default(now())
  createdAt          DateTime @default(now())

  // Foreign Key Field
  machineId String 

  // Relasi: Menghubungkan ke tabel Machine
  machine   Machine @relation(fields: [machineId], references: [id])

  @@map("sensor_data")
  @@index([machineId, timestamp])
}

// Prediksi dari ML
model Prediction {
  id                Int      @id @default(autoincrement())

  // Foreign Key Field: String? agar NULLABLE sesuai kode asli Anda
  machineId         String? 

  prediction        String   
  predictionIndex   Int      
  probability       Float    
  rawOutput         Json     
  riskLevel         String   
  recommendation    String?
  predictedAt       DateTime @default(now())

  // Relasi: Menghubungkan ke tabel Machine
  machine   Machine? @relation(fields: [machineId], references: [id])

  @@map("predictions")
  @@index([machineId, predictedAt])
}

// Tiket Maintenance
model MaintenanceTicket {
  id        Int       @id @default(autoincrement())

  // Foreign Key Field
  machineId String

  issue     String
  status    String    @default("open")
  createdAt DateTime  @default(now())
  closedAt  DateTime?

  // Relasi: Menghubungkan ke tabel Machine
  machine   Machine @relation(fields: [machineId], references: [id])

  @@map("maintenance_tickets")
}

// ===================================
// CHATBOT MODELS (DIPERBARUI)
// Menggunakan struktur referensi (Sederhana)
// ===================================

// 1. Sesi Chat (Judul di Sidebar)
model ChatSession {
  id        String   @id @default(cuid())
  title     String?  // Field baru sesuai referensi (opsional untuk judul chat)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  messages  ChatMessage[] 

  @@map("chat_sessions")
}

// 2. Isi Chat (Gelembung Pesan)
model ChatMessage {
  id        Int      @id @default(autoincrement())
  content   String   @db.Text
  role      String   // "user" | "assistant"
  createdAt DateTime @default(now())
  
  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
  @@index([sessionId, createdAt]) 
}