// prisma/schema.prisma

generator client {
Â  provider = "prisma-client-js"
}

datasource db {
Â  provider = "postgresql"
Â  urlÂ  Â  Â  = env("DATABASE_URL")Â 
Â  directUrl = env("DIRECT_URL")
}

// ===================================
// MODEL INTI (MACHINE)
// ðŸ›‘ FIX: Model Machine harus ada di sini agar relasi dikenali.
// ===================================

model Machine {
Â  idÂ  Â String @id
Â  type String @default("unknown")

Â  sensorReadingsÂ  Â SensorData[]
Â  predictionsÂ  Â  Â  Prediction[]
Â  ticketsÂ  Â  Â  Â  Â  MaintenanceTicket[]

Â  @@map("machines")
}

// ===================================
// MODEL DATA UTAMA
// ===================================

// Raw sensor data sesuai input model ML
model SensorData {
Â  idÂ  Â  Â  Â  Â  Â  Â  Â  Â IntÂ  Â  Â  @id @default(autoincrement())
Â  airTemperatureÂ  Â  Â Float
Â  processTemperature Float
Â  rotationalSpeedÂ  Â  Int
Â  torqueÂ  Â  Â  Â  Â  Â  Â Float
Â  toolWearÂ  Â  Â  Â  Â  Â Int
Â  timestampÂ  Â  Â  Â  Â  DateTime @default(now())
Â  createdAtÂ  Â  Â  Â  Â  DateTime @default(now())

Â  // Foreign Key Field
Â  machineId StringÂ 

Â  // Relasi: Menghubungkan ke tabel Machine
Â  machineÂ  Â Machine @relation(fields: [machineId], references: [id])

Â  @@map("sensor_data")
Â  @@index([machineId, timestamp])
}

// Prediksi dari ML (Sudah diperbaiki dengan relasi)
model Prediction {
Â  idÂ  Â  Â  Â  Â  Â  Â  Â IntÂ  Â  Â  @id @default(autoincrement())

Â  // Foreign Key Field: String? agar NULLABLE, mencegah Foreign Key Violation
Â  machineIdÂ  Â  Â  Â  String?Â 

Â  predictionÂ  Â  Â  Â StringÂ  Â 
Â  predictionIndexÂ  IntÂ  Â  Â Â 
Â  probabilityÂ  Â  Â  FloatÂ  Â Â 
Â  rawOutputÂ  Â  Â  Â  JsonÂ  Â  Â 
Â  riskLevelÂ  Â  Â  Â  StringÂ  Â 
Â  recommendationÂ  Â String?
Â  predictedAtÂ  Â  Â  DateTime @default(now())

Â  // Relasi: Menghubungkan ke tabel Machine (Machine? agar relasi opsional)
Â  machineÂ  Â Machine? @relation(fields: [machineId], references: [id])

Â  @@map("predictions")
Â  @@index([machineId, predictedAt])
}

// Tiket Maintenance (Sudah diperbaiki dengan relasi)
model MaintenanceTicket {
Â  idÂ  Â  Â  Â  IntÂ  Â  Â  Â @id @default(autoincrement())

Â  // Foreign Key Field
Â  machineId String

Â  issueÂ  Â  Â String
Â  statusÂ  Â  StringÂ  Â  @default("open")
Â  createdAt DateTimeÂ  @default(now())
Â  closedAtÂ  DateTime?

Â  // Relasi: Menghubungkan ke tabel Machine
Â  machineÂ  Â Machine @relation(fields: [machineId], references: [id])

Â  @@map("maintenance_tickets")
}

// ===================================
// CHATBOT MODELS (STRUKTUR BERPASANGAN)
// ===================================

// 1. Tabel Utama Sesi Chat
model ChatSession {
Â  idÂ  Â  Â  Â  Â  Â  Â  Â StringÂ  Â  Â  Â  @id @default(cuid())
Â  createdAtÂ  Â  Â  Â  DateTimeÂ  Â  Â  @default(now())
Â  updatedAtÂ  Â  Â  Â  DateTimeÂ  Â  Â  @updatedAt
Â Â 
Â  // Relasi Log: Semua pesan yang ada (untuk history LLM)
Â  messagesÂ  Â  Â  Â  Â ChatMessage[]Â 
Â Â 
Â  // Relasi Struktur: Semua putaran prompt/response (untuk audit/analisis)
Â  promptGroupsÂ  Â  Â PromptGroup[]Â 

Â  @@map("chat_sessions")
}

// 2. Tabel Log Pesan (Setiap pesan adalah 1 baris)
model ChatMessage {
Â  idÂ  Â  Â  Â  Â  Â  Â  Â IntÂ  Â  Â  Â  Â  Â @id @default(autoincrement())
Â  sessionIdÂ  Â  Â  Â  String
Â  contentÂ  Â  Â  Â  Â  StringÂ  Â  Â  Â  @db.Text
Â  roleÂ  Â  Â  Â  Â  Â  Â StringÂ  Â  Â  Â  // 'user' atau 'ai'
Â  createdAtÂ  Â  Â  Â  DateTimeÂ  Â  Â  @default(now())

Â  // Relasi ke Sesi
Â  sessionÂ  Â  Â  Â  Â  ChatSessionÂ  Â @relation(fields: [sessionId], references: [id])
Â Â 
Â  // Relasi Balik ke PromptGroup: Mengidentifikasi pesan ini sebagai bagian dari putaran Q/A
Â  // Satu pesan 'user' akan menjadi promptGroupUser, dan satu pesan 'ai' akan menjadi promptGroupAI
Â  promptGroupUserÂ  PromptGroup?Â  @relation("UserPrompt")
Â  promptGroupAIÂ  Â  PromptGroup?Â  @relation("AIResponse")

Â  @@map("chat_messages")
Â  @@index([sessionId, createdAt])
}

// 3. Tabel Grouping (Setiap baris adalah 1 putaran Q/A)
model PromptGroup {
Â  idÂ  Â  Â  Â  Â  Â  Â  Â IntÂ  Â  Â  Â  Â  Â @id @default(autoincrement())
Â  sessionIdÂ  Â  Â  Â  String
Â  createdAtÂ  Â  Â  Â  DateTimeÂ  Â  Â  @default(now())
Â Â 
Â  sessionÂ  Â  Â  Â  Â  ChatSessionÂ  Â @relation(fields: [sessionId], references: [id])
Â Â 
Â  // Kunci Asing ke ChatMessage (Pesan User)
Â  userMessageIdÂ  Â  IntÂ  Â  Â  Â  Â  Â @unique // Unique: Hanya 1 prompt per PromptGroup
Â  userMessageÂ  Â  Â  ChatMessageÂ  Â @relation("UserPrompt", fields: [userMessageId], references: [id])
Â Â 
Â  // Kunci Asing ke ChatMessage (Pesan AI - bisa null jika AI belum/gagal jawab)
Â  aiMessageIdÂ  Â  Â  Int?Â  Â  Â  Â  Â  @uniqueÂ 
Â  aiMessageÂ  Â  Â  Â  ChatMessage?Â  @relation("AIResponse", fields: [aiMessageId], references: [id])

Â  @@map("prompt_groups")
}